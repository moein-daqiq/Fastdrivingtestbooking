<!doctype html>
<html lang="en">
<head>
  <!-- ===================== Document & SEO ===================== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Driving Test Cancellation Finder | Earlier DVSA Dates — FastDrivingTestFinder</title>
  <link rel="canonical" href="https://fastdrivingtestfinder.co.uk/">
  <meta name="description" content="Find earlier DVSA driving test dates and cancellations UK-wide. We scan centres 24/7 and send instant alerts so you can book or swap a sooner test.">
  <meta property="og:url" content="https://fastdrivingtestfinder.co.uk/">
  <meta property="og:title" content="Driving Test Cancellation Finder — FastDrivingTestFinder">
  <meta property="og:description" content="Find earlier DVSA dates and cancellations. Instant alerts across UK centres.">

  <!-- ===================== Global Config (safe, non-secret) ===================== -->
  <script>
    // Single source of truth
    window.API_BASE = "https://api.fastdrivingtestfinder.co.uk/api";
    window.STRIPE_PUBLISHABLE_KEY = "pk_live_51S4HI5KDKDIajo9AAvqU8YiqHVgZQhQne3pJzejDKrL0s1OCWnOsRk7gcJWdHPl4k5yPIGoGiQ2QFRPzHPm884fO00YoZJ0mDn";
    try { localStorage.removeItem('dvsa_form_autosave_v1'); } catch (e) {}
  </script>

  <!-- Make safe globals for all scripts (avoids ReferenceError when using template strings) -->
  <script>
    const API_BASE = window.API_BASE || '';
    const STRIPE_PUBLISHABLE_KEY = window.STRIPE_PUBLISHABLE_KEY || '';
  </script>

  <!-- ===================== Base Styles ===================== -->
 <style>
  :root{ --line:#e5e7eb; --ink:#0f172a; --muted:#475569; --primary:#2563eb; --primary-dark:#1e40af; --danger:#dc2626; --tint-blue: rgba(37,99,235,.044); --tint-amber: rgba(245,158,11,.055); --tint-slate: rgba(15,23,42,.033); }
  html, body { height: 100%; }
  body{ margin:0; font-family:"Segoe UI","Helvetica Neue",Arial,Helvetica,sans-serif; background:#f7fafc; color:var(--ink); line-height:1.45; }

  /* Keep the whole page centered and constrained */
  .wrap{ max-width:760px; margin:10px auto; background:#fff; border:1px solid var(--line); box-shadow:0 2px 16px rgba(15,23,42,.06) }
  /* In case something else overrides it */
  body > .wrap{ max-width:760px !important; margin:10px auto !important; }

  .strip{ padding:10px 12px; text-align:center; color:#fff; font-weight:700 }
  .strip.title{ background:linear-gradient(180deg,#60a5fa 0%, #3b82f6 100%) }
  .strip.subtitle{ background:#34d399 }
  .strip.important{ background:#fbbf24; color:#111827 }
  .strip + section{ margin-top:14px }

  section.panel, section.blue-panel, section.yellow-panel{
    border:1px solid var(--line); border-radius:10px; box-shadow:0 2px 10px rgba(15,23,42,.04);
    padding:16px 18px; margin:16px; background-clip:padding-box;
  }
  .panel{ background:var(--tint-slate) } .blue-panel{ background:var(--tint-blue) } .yellow-panel{ background:var(--tint-amber) }

  .row{ display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin-top:10px }
  label{ font-size:14px; font-weight:bold; color:var(--ink) }

  .note-line{ display:flex; justify-content:space-between; width:100%; font-size:12px; color:var(--muted); margin-top:2px }
  .section{ margin-bottom:14px } .section-title{ font-weight:700; margin-bottom:8px } .small-note{ color:#475569; font-size:12px; margin-top:4px }

  label.req::after{ content:" *"; color:var(--danger); font-weight:bold; }
  .req-title::after{ content:" *"; color:var(--danger); font-weight:bold; margin-left:4px; }

  /* Test booking type (unchanged) */
  #test-booking-type .heading{ display:grid; grid-template-columns:1fr; text-align:center }
  #test-booking-type .heading .helper{ color:var(--muted); font-size:15.5px; font-weight:400; margin-top:6px }
  #test-booking-type .row{ display:grid; grid-template-columns:1fr 1fr; column-gap:16px; row-gap:10px; align-items:start }
  #btnBook{ grid-column:1; grid-row:1 }  #theoryPass{ grid-column:1; grid-row:2 }
  #btnSwap{ grid-column:2; grid-row:1 }  #swapRef{ grid-column:2; grid-row:2 }
  #test-booking-type .note-line{ display:grid; grid-template-columns:1fr 1fr; gap:16px }

  input, select{
    box-sizing:border-box; height:34px; padding:6px 8px; border:1px solid var(--line); border-radius:4px;
    background:#fff; color:var(--ink);
    font:14px/22px "Segoe UI","Helvetica Neue",Arial,Helvetica,sans-serif;
    transition:border-color .15s, box-shadow .15s;
  }
  input:focus, select:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 2px rgba(37,99,235,.15) }
  .error{ border-color:var(--danger)!important; box-shadow:0 0 0 2px rgba(220,38,38,.15)!important }
  [aria-invalid="true"]{ border-color:var(--danger)!important }
  label.show-error{ color:#991b1b }
  label.show-error::after{
    content:attr(data-error) " ";
    display:block; font-weight:normal; color:#dc2626; font-size:12px; margin-top:4px; line-height:1.2;
    white-space:normal; max-width:32ch
  }

  /* allow phone field to shrink on mobile */
  .phone-mask{ position:relative; flex:1 1 260px; min-width:0 } .phone-mask input{ width:100% }

  .btn{ background:#93c5fd; border:1px solid #bfdbfe; color:#0b1a33; font-weight:700; padding:6px 12px; border-radius:4px; cursor:pointer; height:34px }
  .btn:hover{ background:#60a5fa; color:#fff } .btn.selected{ background:var(--primary-dark); color:#fff; border-color:var(--primary-dark) }

  .yesno button{ height:32px; background:#fff; color:#1e3a8a; border:1px solid var(--line); padding:4px 12px; border-radius:4px; font-weight:600; cursor:pointer }
  .yesno button:hover{ border-color:var(--primary) } .yesno button.selected{ background:#2563eb; color:#fff; border-color:#2563eb }

  .centres-intro{ color:#475569; line-height:1.45; margin:0 0 10px 0 }
  .centres-grid{ display:grid; grid-template-columns:1fr 1fr; gap:16px; align-items:start }
  .centre-field{ display:flex; flex-direction:column; gap:6px } .centre-field input{ width:100% }
  .lock-full{ width:100%!important; max-width:100%!important }
  .centre-input{
    background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"><path fill="%2399a3b3" d="M7 10l5 5 5-5z"/></svg>');
    background-repeat:no-repeat; background-position:right 10px center; padding-right:28px; cursor:text;
  }

  .dt-heading{ margin:0 0 8px 0; font-weight:bold }
  .dt-grid{ display:grid; grid-template-columns:1fr 1fr; gap:16px }
  .field-col{ display:flex; flex-direction:column; gap:6px } .field-col input{ width:100% }

  /* generic inline layout (used for time/notice) */
  .inline{ display:flex; flex-direction:column; gap:8px; width:100% }
  .time-inline{ display:flex; align-items:center; gap:10px; flex-wrap:nowrap }
  .time-input{ width:6ch; max-width:100% }  /* compact control size (use on Notice Period to match AM/PM) */

  .time-inline > span, .days-inline > span{ display:inline-flex; align-items:center; height:34px; line-height:34px }

  .subtotal{ font-weight:bold; margin-top:10px; font-size:16px; text-align:right; color:var(--primary-dark) }
  .indicator{ margin-top:12px; text-align:center; font-weight:bold; display:none }
  .indicator.success{ color:#16a34a } .indicator.fail{ color:#dc2626 }

  .submit-row{ display:flex; align-items:center; gap:12px; margin:16px 0 }
  .status-pill{ padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; background:#eef2ff; color:#1e40af }
  .status-pill.paid{ background:#ecfdf5; color:#16a34a }
  .submit-btn{ flex:1; background:#2563eb; color:#fff; padding:10px; border:none; font-size:15px; border-radius:4px; cursor:pointer; opacity:.6 }
  .submit-btn.enabled{ opacity:1 }
  .pp-row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:8px }
  #stripePayBtn{ width:100%; max-width:360px; background:#635bff }
  #stripeConfirmBtn{ margin-top:12px; width:100%; max-width:360px }
  #stripePanel{ display:none; margin-top:12px; padding:12px; border:1px dashed var(--line); border-radius:10px; background:#fff }

  /* Form grid – mobile first so fields don’t overflow the panel */
  .fields-grid{
    display:grid;
    grid-template-columns: 1fr; /* mobile stacked */
    column-gap:16px;
    row-gap:10px;
    align-items:center;
  }
  @media (min-width:640px){
    .fields-grid{
      grid-template-columns:220px 1fr; /* desktop: label | input */
    }
  }

  .option-text{ flex:1 }
  .promo-row{ display:flex; align-items:center; gap:12px; margin-top:8px; border-top:1px dashed var(--line); padding-top:10px }
</style>


    <!-- ===================== Test Booking Type ===================== -->
    <section id="test-booking-type" class="panel">
      <div class="heading">
        <label class="small">Test Booking Type:</label>
        <div class="helper">Select one option below and provide the required reference.</div>
      </div>
      <div class="row">
        <button class="btn" id="btnBook" aria-pressed="false">Book a New Test</button>
        <input type="text" id="theoryPass" class="lock-full" aria-label="Theory test pass number (from DVSA, usually on paper)" placeholder="Theory test pass number" maxlength="16" autocomplete="off"/>
        <button class="btn" id="btnSwap" aria-pressed="false">Swap an Existing Test</button>
        <input type="text" id="swapRef" class="lock-full" aria-label="DVSA practical test booking reference (usually emailed)" placeholder="8-digit booking reference" maxlength="8" inputmode="numeric" autocomplete="off"/>
      </div>
      <div class="note-line">
        <div>Theory test pass number (from DVSA, usually on paper)</div>
        <div>Practical test booking reference (from DVSA, usually by email)</div>
      </div>
    </section>

    <!-- ===================== Applicant Details ===================== -->
    <section id="applicant-details" class="panel">
      <div class="row heading"><label class="small">Applicant Details:</label></div>

      <div class="fields-grid">
        <label class="req" for="surname">Surname(s):</label>
        <input type="text" id="surname" placeholder="Exactly as shown on your driving licence (field 1)"/>

        <label class="req" for="firstname">First and Middle Name(s):</label>
        <input type="text" id="firstname" placeholder="Exactly as shown on your driving licence (field 2)"/>

        <label class="req" for="drivingLicence">Driving Licence No:</label>
        <input type="text" id="drivingLicence" placeholder="FIRST 16 CHARACTERS ONLY (EXCLUDE THE LAST 2)" maxlength="16"/>

        <label class="req" for="address">Address:</label>
        <input type="text" id="address" placeholder="House number and street name"/>

        <label for="town">Town/City:</label>
        <input type="text" id="town" placeholder="Town/City"/>

        <label class="req" for="postcode">Postcode:</label>
        <input type="text" id="postcode" placeholder="UK postcode (e.g., SW1A 1AA)" inputmode="text" autocomplete="postal-code"/>

        <label class="req" for="email">Email Address:</label>
        <input type="email" id="email" placeholder="If the email is incorrect, you will not receive a confirmation" autocomplete="email"/>

        <label class="req" for="phoneRaw">UK WhatsApp Phone No:</label>
        <div class="phone-mask"><input type="tel" id="phoneRaw" autocomplete="off" placeholder="+44"/></div>

        <div class="small-note">If you do not have a WhatsApp number, the system will not send a confirmation.</div>
      </div>
    </section>


    <!-- ===================== Test Centres ===================== -->
    <section class="blue-panel">
      <div class="row heading"><label class="small">Test Centres:</label></div>
      <p class="centres-intro">We cover all centres in England, Wales, Scotland, and Northern Ireland. Choose the centres you can attend. The first centre is compulsory; up to five additional centres are optional. The more centres you choose, the faster we can find a test.</p>
      <div class="centres-grid">
        <div class="centre-field"><label class="req">Test Centre 1:</label><input type="text" class="lock-full centre-input" placeholder="Choose your centre" list="testCentresList" autocomplete="off" spellcheck="false"/></div>
        <div class="centre-field"><label>Test Centre 2:</label><input type="text" class="lock-full centre-input" placeholder="Choose your centre" list="testCentresList" autocomplete="off" spellcheck="false"/></div>
        <div class="centre-field"><label>Test Centre 3:</label><input type="text" class="lock-full centre-input" placeholder="Choose your centre" list="testCentresList" autocomplete="off" spellcheck="false"/></div>
        <div class="centre-field"><label>Test Centre 4:</label><input type="text" class="lock-full centre-input" placeholder="Choose your centre" list="testCentresList" autocomplete="off" spellcheck="false"/></div>
        <div class="centre-field"><label>Test Centre 5:</label><input type="text" class="lock-full centre-input" placeholder="Choose your centre" list="testCentresList" autocomplete="off" spellcheck="false"/></div>
        <div class="centre-field"><label>Test Centre 6:</label><input type="text" class="lock-full centre-input" placeholder="Choose your centre" list="testCentresList" autocomplete="off" spellcheck="false"/></div>
      </div>
      <datalist id="testCentresList">
  <!-- A -->
  <option value="Aberdeen North"></option>
  <option value="Aberdeen South (Cove)"></option>
  <option value="Aberfeldy"></option>
  <option value="Abergavenny"></option>
  <option value="Aberystwyth (Park Avenue)"></option>
  <option value="Airdrie"></option>
  <option value="Alness"></option>
  <option value="Alnwick"></option>
  <option value="Arbroath"></option>
  <option value="Ashfield"></option>
  <option value="Ashford (Kent)"></option>
  <option value="Atherton (Manchester)"></option>
  <option value="Aylesbury"></option>
  <option value="Ayr"></option>

  <!-- B -->
  <option value="Bala"></option>
  <option value="Ballater"></option>
  <option value="Banbury"></option>
  <option value="Banff"></option>
  <option value="Bangor"></option>
  <option value="Barking (Tanner Street)"></option>
  <option value="Barnet (London)"></option>
  <option value="Barnsley"></option>
  <option value="Barnstaple"></option>
  <option value="Barra"></option>
  <option value="Barrow In Furness"></option>
  <option value="Barry"></option>
  <option value="Basildon"></option>
  <option value="Basingstoke"></option>
  <option value="Bedford"></option>
  <option value="Belvedere (London)"></option>
  <option value="Benbecula Island"></option>
  <option value="Berwick-On-Tweed"></option>
  <option value="Beverley LGV"></option>
  <option value="Birmingham (Garretts Green)"></option>
  <option value="Birmingham (Kings Heath)"></option>
  <option value="Birmingham (Kingstanding)"></option>
  <option value="Birmingham (Shirley)"></option>
  <option value="Birmingham (South Yardley)"></option>
  <option value="Bishopbriggs"></option>
  <option value="Bishops Stortford"></option>
  <option value="Blackburn with Darwen"></option>
  <option value="Blackpool"></option>
  <option value="Bletchley"></option>
  <option value="Blyth"></option>
  <option value="Bodmin"></option>
  <option value="Bolton (Manchester)"></option>
  <option value="Borehamwood (London)"></option>
  <option value="Boston"></option>
  <option value="Bradford (Heaton)"></option>
  <option value="Bradford (Thornbury)"></option>
  <option value="Brecon"></option>
  <option value="Bredbury (Manchester)"></option>
  <option value="Brentwood (London)"></option>
  <option value="Bridgend"></option>
  <option value="Bridlington"></option>
  <option value="Bristol (Avonmouth)"></option>
  <option value="Bristol (Kingswood)"></option>
  <option value="Brodick (Isle of Arran)"></option>
  <option value="Bromley (London)"></option>
  <option value="Buckie"></option>
  <option value="Burgess Hill"></option>
  <option value="Burton on Trent"></option>
  <option value="Bury (Manchester)"></option>
  <option value="Bury St Edmunds"></option>
  <option value="Buxton"></option>

  <!-- C -->
  <option value="Callander"></option>
  <option value="Camborne"></option>
  <option value="Cambridge (Brookmount Court)"></option>
  <option value="Cambridge (Hardwick)"></option>
  <option value="Campbeltown"></option>
  <option value="Canterbury"></option>
  <option value="Cardiff (Llanishen)"></option>
  <option value="Cardigan"></option>
  <option value="Carlisle"></option>
  <option value="Carlisle LGV (Cars)"></option>
  <option value="Carmarthen"></option>
  <option value="Castle Douglas"></option>
  <option value="Chadderton"></option>
  <option value="Cheetham Hill (Manchester)"></option>
  <option value="Chelmsford (Hanbury Road)"></option>
  <option value="Cheltenham"></option>
  <option value="Chertsey (London)"></option>
  <option value="Chester"></option>
  <option value="Chesterfield"></option>
  <option value="Chichester"></option>
  <option value="Chingford (London)"></option>
  <option value="Chippenham"></option>
  <option value="Chorley"></option>
  <option value="Clacton-on-Sea"></option>
  <option value="Colchester"></option>
  <option value="Coventry"></option>
  <option value="Crawley"></option>
  <option value="Crewe"></option>
  <option value="Crieff"></option>
  <option value="Culham LGV"></option>
  <option value="Cumnock"></option>

  <!-- D -->
  <option value="Darlington"></option>
  <option value="Derby (Alvaston)"></option>
  <option value="Doncaster"></option>
  <option value="Dorchester"></option>
  <option value="Dreghorn LGV"></option>
  <option value="Dudley"></option>
  <option value="Dumbarton"></option>
  <option value="Dumfries"></option>
  <option value="Dumfries LGV"></option>
  <option value="Dundee"></option>
  <option value="Dunfermline (Vine)"></option>
  <option value="Dunoon"></option>
  <option value="Duns"></option>
  <option value="Durham"></option>

  <!-- E -->
  <option value="East Kilbride"></option>
  <option value="Eastbourne"></option>
  <option value="Edinburgh (Currie)"></option>
  <option value="Edinburgh (Musselburgh)"></option>
  <option value="Elgin"></option>
  <option value="Enfield (Brancroft Way)"></option>
  <option value="Enfield (Innova Business Park)"></option>
  <option value="Erith (London)"></option>
  <option value="Exeter"></option>
  <option value="Exeter LGV"></option>

  <!-- F -->
  <option value="Farnborough"></option>
  <option value="Featherstone"></option>
  <option value="Folkestone"></option>
  <option value="Forfar"></option>
  <option value="Fort William"></option>
  <option value="Fraserburgh"></option>

  <!-- G -->
  <option value="Gairloch"></option>
  <option value="Galashiels"></option>
  <option value="Gateshead"></option>
  <option value="Gillingham"></option>
  <option value="Gillingham LGV"></option>
  <option value="Girvan"></option>
  <option value="Glasgow (Anniesland)"></option>
  <option value="Glasgow (Baillieston)"></option>
  <option value="Glasgow (Shieldhall)"></option>
  <option value="Gloucester"></option>
  <option value="Golspie"></option>
  <option value="Goodmayes (London)"></option>
  <option value="Gosforth"></option>
  <option value="Grangemouth"></option>
  <option value="Grantham (Somerby)"></option>
  <option value="Grantown-On-Spey"></option>
  <option value="Greenford (Horsenden Lane)"></option>
  <option value="Greenham"></option>
  <option value="Greenock"></option>
  <option value="Grimsby Coldwater"></option>
  <option value="Guildford"></option>

  <!-- H -->
  <option value="Haddington"></option>
  <option value="Halifax"></option>
  <option value="Hamilton"></option>
  <option value="Hartlepool"></option>
  <option value="Hastings (Ore)"></option>
  <option value="Hawick"></option>
  <option value="Heckmondwike"></option>
  <option value="Hendon (London)"></option>
  <option value="Hereford"></option>
  <option value="Herne Bay"></option>
  <option value="Hexham"></option>
  <option value="Heysham"></option>
  <option value="High Wycombe"></option>
  <option value="Hinckley"></option>
  <option value="Hornchurch (London)"></option>
  <option value="Horsforth"></option>
  <option value="Huddersfield"></option>
  <option value="Hull"></option>
  <option value="Huntly"></option>

  <!-- I / J / K -->
  <option value="Inveraray"></option>
  <option value="Inverness (Longman Drive)"></option>
  <option value="Inverness (Seafield Road)"></option>
  <option value="Inverurie"></option>
  <option value="Ipswich"></option>
  <option value="Irvine"></option>
  <option value="Islay Island"></option>
  <option value="Isle of Mull"></option>
  <option value="Isle of Skye (Portree)"></option>
  <option value="Isle of Tiree"></option>
  <option value="Isles of Scilly"></option>
  <option value="Isleworth (Fleming Way)"></option>
  <option value="Kelso"></option>
  <option value="Kendal (Oxenholme Road)"></option>
  <option value="Kettering"></option>
  <option value="Kings Lynn"></option>
  <option value="Kingussie"></option>
  <option value="Kirkcaldy"></option>
  <option value="Kirkham LGV"></option>
  <option value="Knaresborough"></option>
  <option value="Kyle of Lochalsh"></option>

  <!-- L -->
  <option value="Lanark"></option>
  <option value="Launceston"></option>
  <option value="Lee On The Solent"></option>
  <option value="Leeds (Cottom Mill)"></option>
  <option value="Leeds (Fearnville)"></option>
  <option value="Leicester (Cannock Street)"></option>
  <option value="Leicester (Wigston)"></option>
  <option value="Leighton Buzzard (Stanbridge Road)"></option>
  <option value="Lerwick"></option>
  <option value="Letchworth"></option>
  <option value="Lichfield"></option>
  <option value="Lincoln"></option>
  <option value="Livingston"></option>
  <option value="Llanelli"></option>
  <option value="Llantrisant"></option>
  <option value="Loughborough"></option>
  <option value="Loughton (London)"></option>
  <option value="Lowestoft (Mobbs Way)"></option>
  <option value="Ludlow"></option>
  <option value="Luton"></option>

  <!-- M -->
  <option value="Macclesfield"></option>
  <option value="Machrihanish LGV"></option>
  <option value="Maidstone"></option>
  <option value="Mallaig"></option>
  <option value="Malton"></option>
  <option value="Melton Mowbray"></option>
  <option value="Merthyr Tydfil"></option>
  <option value="Middlesbrough"></option>
  <option value="Mill Hill (London)"></option>
  <option value="Mitcham (London)"></option>
  <option value="Monmouth"></option>
  <option value="Montrose"></option>
  <option value="Morden (London)"></option>

  <!-- N -->
  <option value="Nelson"></option>
  <option value="Newcastle upon Tyne (Gosforth)"></option>
  <option value="Newcastle-Under-Lyme (Stoke-on-Trent)"></option>
  <option value="Newport (Isle of Wight)"></option>
  <option value="Newbury"></option>
  <option value="Norwich"></option>
  <option value="Nottingham"></option>

  <!-- O / P -->
  <option value="Oban"></option>
  <option value="Oxford"></option>
  <option value="Peebles"></option>
  <option value="Pembroke Dock"></option>
  <option value="Penzance"></option>
  <option value="Perth (Arran Road)"></option>
  <option value="Peterborough"></option>
  <option value="Peterborough LGV"></option>
  <option value="Peterhead"></option>
  <option value="Pinner (London)"></option>
  <option value="Pitlochry"></option>
  <option value="Plymouth"></option>
  <option value="Plymouth LGV"></option>
  <option value="Pontefract"></option>
  <option value="Poole"></option>
  <option value="Portsmouth"></option>
  <option value="Preston"></option>
  <option value="Pwllheli"></option>

  <!-- R -->
  <option value="Reading"></option>
  <option value="Redditch"></option>
  <option value="Redhill Aerodrome"></option>
  <option value="Rhyl"></option>
  <option value="Rochdale (Manchester)"></option>
  <option value="Rookley LGV"></option>
  <option value="Rotherham"></option>
  <option value="Rothesay"></option>
  <option value="Rugby"></option>

  <!-- S -->
  <option value="Sale (Manchester)"></option>
  <option value="Salisbury"></option>
  <option value="Scarborough"></option>
  <option value="Scunthorpe"></option>
  <option value="Sevenoaks"></option>
  <option value="Sheffield (Handsworth)"></option>
  <option value="Sheffield (Middlewood Road)"></option>
  <option value="Shrewsbury"></option>
  <option value="Sidcup (London)"></option>
  <option value="Skegness"></option>
  <option value="Skipton"></option>
  <option value="Slough (London)"></option>
  <option value="Southall (London)"></option>
  <option value="Southampton (Maybush)"></option>
  <option value="Southend-on-Sea"></option>
  <option value="Southport (Liverpool)"></option>
  <option value="Speke (Liverpool)"></option>
  <option value="St Albans"></option>
  <option value="St Helens (Liverpool)"></option>
  <option value="Stafford"></option>
  <option value="Steeton"></option>
  <option value="Stevenage"></option>
  <option value="Stirling"></option>
  <option value="Stoke-On-Trent (Cobridge)"></option>
  <option value="Stoke-on-Trent (Newcastle-Under-Lyme)"></option>
  <option value="Stornoway"></option>
  <option value="Stornoway LGV"></option>
  <option value="Stranraer"></option>
  <option value="Sunderland"></option>
  <option value="Swansea"></option>
  <option value="Swindon"></option>
  <option value="Swindon LGV"></option>
  <option value="Swithland (Switch Island)"></option>

  <!-- T / U -->
  <option value="Telford"></option>
  <option value="Thurrock LGV (London)"></option>
  <option value="Thurso"></option>
  <option value="Tilbury"></option>
  <option value="Tolworth (London)"></option>
  <option value="Tottenham"></option>
  <option value="Trowbridge"></option>
  <option value="Tunbridge Wells"></option>
  <option value="Ullapool"></option>
  <option value="Upton"></option>
  <option value="Uxbridge (London)"></option>

  <!-- W -->
  <option value="Wakefield"></option>
  <option value="Wallasey"></option>
  <option value="Walton LGV"></option>
  <option value="Wanstead (London)"></option>
  <option value="Warrington"></option>
  <option value="Warwick (Wedgnock House)"></option>
  <option value="Watford"></option>
  <option value="Watnall"></option>
  <option value="Wednesbury"></option>
  <option value="Weedon LGV"></option>
  <option value="Wellingborough"></option>
  <option value="West Didsbury (Manchester)"></option>
  <option value="West Wickham (London)"></option>
  <option value="Weston-super-Mare"></option>
  <option value="Whitby"></option>
  <option value="Wick"></option>
  <option value="Widnes"></option>
  <option value="Winchester"></option>
  <option value="Wolverhampton"></option>
  <option value="Wood Green (London)"></option>
  <option value="Worcester"></option>
  <option value="Workington"></option>
  <option value="Worksop"></option>
  <option value="Worthing"></option>
  <option value="Worthing LGV"></option>
  <option value="Wrexham"></option>
  <option value="Wrexham LGV"></option>

  <!-- Y / Z -->
  <option value="Yeading (London)"></option>
  <option value="Yeovil"></option>
  <option value="York"></option>
</datalist>

      <p style="margin-top:10px;color:#374151;font-size:13px">
        <strong>Note:</strong> Selection of any of the following busy centres will cost you additional £30. If they are selected 2 times, you will pay 2×£30.
        <br><em>Barking - Chertsey (London) - Chingford - Farnborough - Goodmayes - Greenford - High Wycombe - Hornchurch - Hounslow - Leighton Buzzard - Letchworth - Luton - Morden - Oxford - Pinner - Reading - Slough - Southall - Tolworth - Uxbridge - Wanstead - West Didsbury (Manchester)</em>
      </p>
    </section>

    <!-- ===================== Date and Time Window ===================== -->
    <section class="yellow-panel">
      <div class="row heading"><label class="small dt-heading">Date and Time Window:</label></div>
      <div class="dt-grid">
        <div class="field-col"><label for="earliestDate">Earliest Date:</label><input id="earliestDate" class="lock-full" type="date" placeholder="dd/mm/yyyy"/></div>
        <div class="field-col"><label for="latestDate">Latest Date:</label><input id="latestDate" class="lock-full" type="date" placeholder="dd/mm/yyyy"/></div>
        <div class="field-col">
          <label for="unavailInput">My Unavailable Dates:</label>
          <div class="multi-date" id="unavail"><input id="unavailInput" class="calendar-input lock-full" type="text" placeholder="Select one or more dates" readonly/><div class="calendar-dropdown" id="unavailCal"></div></div>
        </div>
        <div class="field-col">
          <label for="instrInput">Instructor Unavailable Dates:</label>
          <div class="multi-date" id="instr"><input id="instrInput" class="calendar-input lock-full" type="text" placeholder="Select one or more dates" readonly/><div class="calendar-dropdown" id="instrCal"></div></div>
        </div>
        <div class="field-col">
          <label>Available Time Window:</label>
          <div class="time-inline">
            <input type="number" id="timeFrom" min="1" max="12" value="7" class="time-input" aria-label="From hour"/><span>AM</span>
            <input type="number" id="timeTo" min="1" max="12" value="7" class="time-input" aria-label="To hour"/><span>PM</span>
          </div>
        </div>
        <div class="field-col">
          <label>Notice Period: 1–15 days</label>
          <div class="days-inline"><input type="number" id="noticeDays" class="lock-full" min="1" max="15" value="1" aria-label="Notice days"/><span>Day (s)</span></div>
        </div>
      </div>
    </section>

    <!-- ===================== Confirmation and Agreements ===================== -->
    <section class="panel">
      <div class="section">
        <div class="section-title req-title">Confirmation and Agreement</div>
        <label class="option" style="display:flex; align-items:flex-start; gap:8px; margin-bottom:10px;"><input type="checkbox" name="agreement1"/>I confirm I have read the pricing, refund policy, and terms of service, and that the information I have provided is correct.</label>
      </div>
      <div class="section">
        <div class="section-title req-title">Consent and Data Usage Agreement</div>
        <label class="option" style="display:flex; align-items:flex-start; gap:8px; margin-bottom:10px;"><input type="checkbox" name="agreement2"/>I consent to my data being stored temporarily until my test is booked. I can withdraw at any time by sending an email.</label>
      </div>
      <div class="section">
        <div class="section-title req-title">Test Booking and Test Centre</div>
        <label class="option" style="display:flex; align-items:flex-start; gap:8px; margin-bottom:10px;"><input type="checkbox" name="agreement3"/>If we cannot find a test within your date range, you authorise us to continue searching for up to 30 additional calendar days. If we still cannot find one, you will receive a full refund.</label>
        <label class="option" style="display:flex; align-items:flex-start; gap:8px; margin-bottom:10px;"><input type="checkbox" name="agreement4"/>If you later ask to change your test centre, this will be treated as a new search and additional fees will apply. Only choose centres you can attend.</label>
      </div>
    </section>

    <!-- ===================== Payment (Stripe on-page) ===================== -->
    <section class="panel">
      <div class="section">
        <p><b>Payment:</b><br>Please read the information below and answer each “Yes/No” question accurately so the correct amount is calculated.</p>

        <div class="option row">
          <div class="option-text">1. High-priority searching? +£30<br><small>We will run a separate high-priority search and book the first suitable DVSA slot for you. Otherwise, your request stays in the standard queue.</small></div>
          <div class="yesno" role="group" aria-label="Yes or No"><button type="button" data-price="30">Yes</button><button type="button" data-price="0">No</button></div>
        </div>

        <div class="option row">
          <div class="option-text">2. Include weekend test slots? +£30<br><small>If a weekend test cannot be found, the £30 is not refundable.</small></div>
          <div class="yesno" role="group" aria-label="Yes or No"><button type="button" data-price="30">Yes</button><button type="button" data-price="0">No</button></div>
        </div>

        <div class="subtotal" id="totalLine">Total: £0.00</div>

        <div class="promo-row"><label for="promoCode">Promo Code:</label><input type="text" id="promoCode" placeholder="Enter promo code (optional)"/></div>

        <div class="pp-row"><button id="stripePayBtn" class="submit-btn enabled">Payment options</button></div>

        <div id="stripePanel">
          <div id="stripeMsg" class="indicator" style="display:none"></div>
          <div id="payment-element" style="margin-top:8px"></div>
          <button id="stripeConfirmBtn" class="submit-btn enabled">Pay now</button>
        </div>

        <div class="small note" style="margin-top:6px">Submit will be enabled after the payment.</div>
        <div class="submit-row"><div id="payStatus" class="status-pill">Payment: Not Paid</div><button class="submit-btn" id="submitBtn" disabled>SUBMIT</button></div>
        <div id="liveErrors" class="live-errors" role="status" aria-live="assertive" style="display:none"></div>
        <div id="paymentIndicator" class="indicator"></div>
      </div>
    </section>
  </div>

  <!-- ===================== Shared JS Utilities (validators) ===================== -->
  <script>
    function findLabelFor(input){
      if (!input) return null;
      let prev = input.previousElementSibling;
      if (prev && prev.tagName === 'LABEL') return prev;
      let node = input;
      while (node && node.previousElementSibling){
        node = node.previousElementSibling;
        if (node.tagName === 'LABEL') return node;
      }
      return null;
    }
    function markValidity(input, isValid, message){
      if (!input) return;
      const label = findLabelFor(input);
      const hasVal = (input.value || '').trim() !== '';
      input.classList.toggle('error', !isValid && hasVal);
      input.setAttribute('aria-invalid', (!isValid && hasVal) ? 'true' : 'false');
      if (label){
        if (!isValid && hasVal){ label.classList.add('show-error'); label.setAttribute('data-error', message || ''); }
        else { label.classList.remove('show-error'); label.removeAttribute('data-error'); }
      }
    }
  </script>

  <!-- ===================== Scripts ===================== -->
  <script>
    /* Booking Type + constraints (+recalc for £150/£70) */
    (function(){
      const btnBook=document.getElementById('btnBook');
      const btnSwap=document.getElementById('btnSwap');
      const theoryPass=document.getElementById('theoryPass');
      const swapRef=document.getElementById('swapRef');

      function select(btn){
        [btnBook, btnSwap].forEach(b => { b && b.classList.remove('selected'); b && b.setAttribute('aria-pressed','false'); });
        btn.classList.add('selected'); btn.setAttribute('aria-pressed','true');
        if(btn===btnSwap){ swapRef?.setAttribute('required','required'); }
        else{ swapRef?.removeAttribute('required'); }
        window._recalcTotal && window._recalcTotal();
      }
      btnBook?.addEventListener('click', () => select(btnBook));
      btnSwap?.addEventListener('click', () => select(btnSwap));

      theoryPass?.addEventListener('input', () => { theoryPass.value = theoryPass.value.replace(/[^a-z0-9]/gi, '').slice(0, 16); });
      swapRef?.addEventListener('input', () => {
        swapRef.value = swapRef.value.replace(/\D/g, '').slice(0, 8);
        if(btnSwap?.classList.contains('selected')){ markValidity(swapRef, swapRef.value.length===8, 'Enter the 8-digit DVSA booking reference.'); }
      });
    })();
  </script>

  <script>
    /* Applicant details validation + phone + postcode */
    (function(){
      const dl=document.getElementById('drivingLicence');
      dl?.addEventListener('input', () => {
        dl.value = dl.value.replace(/[^a-z0-9]/gi, '').toUpperCase().slice(0, 16);
        markValidity(dl, dl.value.length === 16, 'Enter the first 16 characters only.');
      });

      const email=document.getElementById('email');
      const emailRe=/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
      email?.addEventListener('input', ()=>{
        const ok = email.value.trim()==='' ? true : emailRe.test(email.value.trim());
        markValidity(email, ok, 'Enter a valid email address.');
      });

      const pc=document.getElementById('postcode');
      const ukPost=/^([Gg][Ii][Rr] 0[Aa]{2})|((([A-Za-z][0-9]{1,2})|(([A-Za-z][A-Ha-hJ-Yj-y][0-9]{1,2})|(([A-Za-z][0-9][A-Za-z])|([A-Za-z][A-Ha-hJ-Yj-y][0-9]?[A-Za-z]?))))\s?[0-9][A-Za-z]{2})$/;
      if(pc){
        pc.addEventListener('keydown', (e)=>{
          const allowedNav = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'];
          if (allowedNav.includes(e.key)) return;
          if (/^[a-z0-9 ]$/i.test(e.key)) return;
          e.preventDefault();
        });
        pc.addEventListener('input', ()=>{
          let v = pc.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
          if (v.length > 3) v = v.slice(0, v.length - 3) + ' ' + v.slice(v.length - 3);
          pc.value = v;
          const ok = pc.value.trim()==='' ? true : ukPost.test(pc.value);
          markValidity(pc, ok, 'Enter a valid UK postcode (e.g., SW1A 1AA).');
        });
      }

      const phoneInput=document.getElementById('phoneRaw');
      if(phoneInput){
        function normalize(){
          let digits = phoneInput.value.replace(/\D/g,'');
          if(digits.startsWith('44')) digits = digits.slice(2);
          if(digits.startsWith('0')) digits = digits.slice(1);
          digits = digits.slice(0,10);
          phoneInput.value = digits.length ? ('+44 ' + digits) : '+44';
          const ok = digits.length === 10;
          markValidity(phoneInput, ok || phoneInput.value.trim()==='+44', 'Enter a 10-digit UK mobile after +44.');
        }
        phoneInput.addEventListener('input', normalize);
        phoneInput.addEventListener('blur', normalize);
        if(!phoneInput.value) phoneInput.value = '+44';
      }
    })();
  </script>

  <script>
    /* Centres: datalist with autocomplete OFF (+recalc on change) */
    (function(){
      document.querySelectorAll('.centre-input').forEach(inp=>{
        inp.autocomplete = 'off';
        inp.spellcheck = false;
        ['input','change','blur'].forEach(ev=>{
          inp.addEventListener(ev, ()=>{ window._recalcTotal && window._recalcTotal(); });
        });
      });
    })();
  </script>

  <script>
  /* Multi-date pickers */
  (function(){
    const pad=n=>String(n).padStart(2,'0');
    const fmt=d=>`${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
    const iso=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${d.getDate()}`;
    const fromYMD=s=>{const [y,m,dd]=s.split('-').map(Number);return new Date(y,m-1,dd)};

    function makeMultiDatePicker(wrapperId,inputId,dropdownId){
      const wrapper=document.getElementById(wrapperId);
      const input=document.getElementById(inputId);
      const dropdown=document.getElementById(dropdownId);
      if(!wrapper||!input||!dropdown)return;

      let view=new Date();view.setDate(1);
      const selected=new Set();

      dropdown.addEventListener('mousedown',e=>e.stopPropagation());
      function updateInput(){ input.value=Array.from(selected).sort().map(s=>fmt(fromYMD(s))).join(', '); }

      function render(){
        dropdown.innerHTML='';dropdown.style.display='block';
        const header=document.createElement('div');header.style.display='flex';header.style.justifyContent='space-between';header.style.alignItems='center';header.style.marginBottom='6px';
        const title=document.createElement('div');title.textContent=view.toLocaleString(undefined,{month:'long',year:'numeric'});
        const nav=document.createElement('div');
        const prev=document.createElement('button');prev.textContent='‹';
        const next=document.createElement('button');next.textContent='›';
        [prev,next].forEach(b=>{b.style.border='1px solid #ddd';b.style.background='#fafafa';b.style.borderRadius='4px';b.style.padding='4px 6px';b.style.cursor='pointer';b.addEventListener('mousedown',e=>e.stopPropagation())});
        prev.onclick=()=>{view.setMonth(view.getMonth()-1);render()};
        next.onclick=()=>{view.setMonth(view.getMonth()+1);render()};
        nav.append(prev,next);header.append(title,nav);dropdown.append(header);

        const dow=document.createElement('div');dow.style.display='grid';dow.style.gridTemplateColumns='repeat(7,1fr)';dow.style.gap='4px';
        ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(n=>{const c=document.createElement('div');c.textContent=n;c.style.textAlign='center';c.style.padding='6px 0';c.style.fontWeight='bold';c.style.background='#f7f7f7';c.style.borderRadius='4px';dow.append(c)});
        dropdown.append(dow);

        const grid=document.createElement('div');grid.style.display='grid';grid.style.gridTemplateColumns='repeat(7,1fr)';grid.style.gap='4px';
        const first=new Date(view.getFullYear(),view.getMonth(),1);
        let startIndex=first.getDay();if(startIndex===0)startIndex=7;
        for(let i=1;i<startIndex;i++){const b=document.createElement('div');b.style.color='#bbb';b.style.background='#fafafa';b.style.border='1px solid #eee';b.style.borderRadius='4px';grid.append(b)}
        const daysInMonth=new Date(view.getFullYear(),view.getMonth()+1,0).getDate();
        for(let d=1;d<=daysInMonth;d++){
          const cell=document.createElement('div');cell.textContent=d;
          cell.style.textAlign='center';cell.style.padding='6px 0';cell.style.borderRadius='4px';cell.style.border='1px solid #eee';cell.style.background='#fff';cell.style.cursor='pointer';
          const dateObj=new Date(view.getFullYear(),view.getMonth(),d);const key=iso(dateObj);
          if(selected.has(key)){cell.style.background='#1a73e8';cell.style.color='#fff';cell.style.borderColor='#1a73e8';cell.style.fontWeight='bold'}
          cell.addEventListener('mousedown',e=>e.stopPropagation());
          cell.onclick=()=>{if(selected.has(key))selected.delete(key);else selected.add(key);updateInput();render()};
          grid.append(cell)
        }
        dropdown.append(grid);

        const footer=document.createElement('div');footer.style.display='flex';footer.style.gap='8px';footer.style.marginTop='8px';
        const clearBtn=document.createElement('button');clearBtn.textContent='Clear';
        const closeBtn=document.createElement('button');closeBtn.textContent='Close';
        [clearBtn,closeBtn].forEach(b=>{b.style.flex='1';b.style.padding='6px';b.style.border='1px solid #ddd';b.style.borderRadius='4px';b.style.cursor='pointer';b.addEventListener('mousedown',e=>e.stopPropagation())});
        clearBtn.onclick=()=>{selected.clear();updateInput();render()};
        closeBtn.onclick=()=>{dropdown.style.display='none'};
        footer.append(clearBtn,closeBtn);dropdown.append(footer)
      }

      input.addEventListener('click',e=>{e.stopPropagation();dropdown.style.display=dropdown.style.display==='block'?'none':'block';if(dropdown.style.display==='block')render()});
      document.addEventListener('mousedown',e=>{if(!wrapper.contains(e.target))dropdown.style.display='none'})
    }

    makeMultiDatePicker('unavail','unavailInput','unavailCal');
    makeMultiDatePicker('instr','instrInput','instrCal');
  })();
  </script>

  <script>
  /* Payment: totals + promo + custom fees (book/swap + busy centres) */
  (function(){
    const groups     = document.querySelectorAll('.yesno');
    const promoInput = document.getElementById('promoCode');
    const totalLine  = document.getElementById('totalLine');

    const BUSY = new Set([
      'barking','chertsey','chertsey (london)','chertsey london','chingford','farnborough','goodmayes','greenford',
      'high wycombe','hornchurch','hounslow','leighton buzzard','letchworth','luton','morden',
      'oxford','pinner','reading','slough','southall','tolworth','uxbridge','wanstead',
      'west didsbury','west didsbury (manchester)'
    ]);

    function normalizeCentreName(v){
      return (v||'').toLowerCase().replace(/\s*\([^)]*\)/g,'').replace(/\s+/g,' ').trim();
    }
    function money(n){ return `£${n.toFixed(2)}`; }

    function baseSumFromYesNo(){
      let sum = 0;
      document.querySelectorAll('.yesno button.selected').forEach(b=>{
        const price = Number(b.dataset.price||0);
        if (!isNaN(price)) sum += price;
      });
      return sum;
    }

    function bookingSwapFee(){
      const book = document.getElementById('btnBook')?.classList.contains('selected');
      const swap = document.getElementById('btnSwap')?.classList.contains('selected');
      if (book) return 150; if (swap) return 70; return 0;
    }

    function busyCentresSurcharge(){
      let count = 0;
      document.querySelectorAll('.centre-input').forEach(inp=>{
        const v = normalizeCentreName(inp.value);
        if (v && BUSY.has(v)) count += 1;
      });
      return count * 30;
    }

    function promoDiscount(sum){
      if (!promoInput) return 0;
      const code = (promoInput.value||'').trim().toUpperCase();
      if (!code) return 0;
      if (code === 'SAVE10') return Math.min(10, sum);
      if (code === 'SAVE20') return Math.min(20, sum);
      if (code === 'OFF10')  return +(sum*0.10).toFixed(2);
      return 0;
    }

    function recalc(){
      const yesno = baseSumFromYesNo();
      const bookSwap = bookingSwapFee();
      const busy = busyCentresSurcharge();
      const gross = yesno + bookSwap + busy;
      const disc = promoDiscount(gross);
      let total = Math.max(0, gross - disc);
      const isBook = document.getElementById('btnBook')?.classList.contains('selected');
      const isSwap = document.getElementById('btnSwap')?.classList.contains('selected');
      if (isBook) total = Math.max(150, total);
      if (isSwap) total = Math.max(70, total);
      totalLine && (totalLine.textContent = `Total: ${money(total)}`);
    }

    window._recalcTotal = recalc;

    groups.forEach(g=>{
      g.addEventListener('click', e=>{
        const btn = e.target.closest('button'); if (!btn) return;
        g.querySelectorAll('button').forEach(b=>{ b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
        btn.classList.add('selected'); btn.setAttribute('aria-pressed','true');
        recalc();
      });
    });

    promoInput?.addEventListener('input', recalc);
    promoInput?.addEventListener('change', recalc);

    recalc();
  })();
  </script>

  <script>
    /* Search submit + health + stop button + (NEW) immediate upsert after payment */
    (() => {
      const API_TOKEN = 'YOUR_REAL_API_TOKEN'; // do NOT ship real secrets client-side

      const $  = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));

      const pad = (n) => String(n).padStart(2,'0');
      const toHH    = (n) => `${pad((+n||0) === 12 ? 0 : (+n||0))}:00`;
      const toHHpm  = (n) => `${pad((+n||0) === 12 ? 12 : (+n||0)+12)}:00`;

      const ymd = (el) => {
        const v = (el && el.value ? el.value.trim() : '');
        if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
        const m = v.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        return m ? `${m[3]}-${m[2]}-${m[1]}` : '';
      };

      const normalizePhone = (v) => {
        let d = (v||'').replace(/\D/g,'');
        if (d.startsWith('44')) d = d.slice(2);
        if (d.startsWith('0'))  d = d.slice(1);
        d = d.slice(0,10);
        return d ? ('0' + d) : '';
      };

      const toast = (msg, ok=true) => {
        let t = document.getElementById('apiToast');
        if (!t) {
          t = document.createElement('div'); t.id = 'apiToast';
          t.style.cssText = 'position:fixed;right:16px;bottom:16px;z-index:9999;padding:10px 14px;border-radius:6px;box-shadow:0 6px 18px rgba(0,0,0,.15);transition:opacity .3s';
          document.body.appendChild(t);
        }
        t.style.background = ok ? '#ecfdf5' : '#fef2f2';
        t.style.color      = ok ? '#065f46' : '#991b1b';
        t.textContent = msg; t.style.opacity = '1';
        setTimeout(()=>{ t.style.opacity='0' }, 3500);
      };

      async function healthCheck() {
        try {
          const r = await fetch(`${API_BASE}/health`);
          const j = await r.json();
          if (j && j.ok) {
            const sub = document.querySelector('.strip.subtitle');
            if (sub && !document.getElementById('apiHealthBadge')) {
              s.style.cssText = 'margin-left:8px;font-weight:700;color:#064e3b;background:#d1fae5;padding:2px 6px;border-radius:999px';
              sub.appendChild(s);
            }
            return true;
          }
        } catch (_) {}
        return false;
      }

      function ensureStopButton() {
        if (document.getElementById('stopSearchBtn')) return;
        const btn = document.createElement('button');
        btn.id = 'stopSearchBtn'; btn.type = 'button'; btn.textContent = 'Stop searching';
        btn.title = 'Disable this search so the bot stops scanning/swapping';
        btn.style.cssText = 'position:fixed;left:16px;bottom:16px;z-index:9999;padding:10px 14px;border-radius:8px;border:0;background:#fee2e2;color:#991b1b;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,.15);cursor:pointer';
        btn.addEventListener('click', disableCurrentSearch);
        document.body.appendChild(btn);
      }

      function currentSearchId() { return localStorage.getItem('dvsa_last_search_id') || ''; }

      async function disableCurrentSearch() {
        const id = currentSearchId();
        if (!id) { toast('No active search id found on this device.', false); return; }
        try {
          const r = await fetch(`${API_BASE}/search/${encodeURIComponent(id)}/disable`, {
            method: 'POST', headers: { 'Authorization': `Bearer ${API_TOKEN}` }
          });
          const t = await r.text();
          if (r.status === 501) { toast('Disable not available in this build (backend). I can enable it if you want.', false); return; }
          if (!r.ok) throw new Error(t || `HTTP ${r.status}`);
          toast('Search disabled. The bot will stop scanning.', true);
          const b = document.getElementById('stopSearchBtn'); if (b) { b.disabled = true; b.style.opacity = '0.6'; b.textContent = 'Stopped'; }
        } catch (e) { toast('Failed to disable: ' + (e?.message || e), false); }
      }

      // --- NEW: Build payload matching the API SearchIn model + include search_id ---
      function collectApiPayload(includeSearchId=true) {
        const centresArr = $$('.centre-input').map(i => i.value.trim()).filter(Boolean);
        const swapSelected  = document.getElementById('btnSwap')?.classList.contains('selected');
        const bookSelected  = document.getElementById('btnBook')?.classList.contains('selected');
        const swapRef       = document.getElementById('swapRef')?.value.trim() || '';
        const theoryPass    = document.getElementById('theoryPass')?.value.trim() || '';

        const payload = {
          // identity
          email:  document.getElementById('email')?.value.trim() || null,
          phone:  normalizePhone(document.getElementById('phoneRaw')?.value),
          // booking type + keys expected by backend
          booking_type: bookSelected ? 'new' : (swapSelected ? 'swap' : 'new'),
          licence_number:  document.getElementById('drivingLicence')?.value.trim() || null,
          booking_reference: swapSelected ? swapRef : null,
          theory_pass:       bookSelected ? theoryPass : null,
          // windows
          date_window_from: ymd(document.getElementById('earliestDate')),
          date_window_to:   ymd(document.getElementById('latestDate')),
          time_window_from: toHH(document.getElementById('timeFrom')?.value),
          time_window_to:   toHHpm(document.getElementById('timeTo')?.value),
          // centres
          centres: centresArr,
          // placeholder options object (keep shape)
          options: {}
        };
        if (includeSearchId) {
          const sid = currentSearchId();
          if (sid) payload.search_id = Number(sid);
        }
        // prune empties
        Object.keys(payload).forEach(k => {
          if (payload[k] === undefined || payload[k] === null || payload[k] === '') delete payload[k];
        });
        return payload;
      }

      // --- NEW: push data to the same row immediately (used after payment success) ---
      async function upsertSearchRecord(silent=false) {
        const sid = currentSearchId();
        if (!sid) { if (!silent) toast('No search ID to update yet.', false); return false; }
        const payload = collectApiPayload(true);
        try {
          const r = await fetch(`${API_BASE}/search`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const text = await r.text();
          if (!r.ok) throw new Error(text || `HTTP ${r.status}`);
          if (!silent) toast('Details saved to your search.', true);
          return true;
        } catch (e) {
          if (!silent) toast('Failed to save details: ' + (e?.message || e), false);
          return false;
        }
      }
      // expose for Stripe handler
      window._upsertSearchRecord = upsertSearchRecord;

      async function submitToApi() {
        const btn = document.getElementById('submitBtn');
        if (!btn || btn.disabled) return;

        // Validations (front-end)
        const centresOK = $$('.centre-input').some(i => (i.value||'').trim());
        if (!centresOK) return toast('Select at least one test centre.', false);
        const from = ymd(document.getElementById('earliestDate'));
        const to   = ymd(document.getElementById('latestDate'));
        if (!from || !to) return toast('Choose earliest/latest dates.', false);

        const licence = document.getElementById('drivingLicence')?.value.trim() || '';
        if (licence.length !== 16) return toast('Enter the first 16 characters of your licence.', false);

        const email = document.getElementById('email')?.value.trim() || '';
        if (!email) return toast('Enter your email.', false);

        const phone = normalizePhone(document.getElementById('phoneRaw')?.value);
        if (!phone) return toast('Enter your WhatsApp phone.', false);

        const swapSelected = document.getElementById('btnSwap')?.classList.contains('selected');
        if (swapSelected && !/^\d{8}$/.test((document.getElementById('swapRef')?.value||''))) {
          return toast('Swap selected: add the 8-digit DVSA booking reference.', false);
        }

        // Send to /api/search (creates new if no id; updates if id present)
        try {
          btn.disabled = true; btn.classList.remove('enabled');
          const payload = collectApiPayload(true);
          const r = await fetch(`${API_BASE}/search`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const text = await r.text(); let j; try { j = JSON.parse(text) } catch { j = null; }
          if (!r.ok) throw new Error(j?.detail || j?.error || text || `HTTP ${r.status}`);
          const id = j?.id || j?.search_id || currentSearchId() || '';
          if (id) { localStorage.setItem('dvsa_last_search_id', String(id)); ensureStopButton(); }
          toast(id ? `Search saved: ${id}` : 'Search saved', true);
          console.log('Gateway response:', j);

          // optional refresh
          setTimeout(() => { window.location.reload(); }, 600);

        } catch (err) {
          console.error(err); toast(`API error: ${err?.message || err}`, false);
        } finally {
          // keep disabled; payment success already enabled it
        }
      }

      window.addEventListener('DOMContentLoaded', async () => {
        await healthCheck();
        if (currentSearchId()) ensureStopButton();
        document.getElementById('submitBtn')?.addEventListener('click', (e) => { e.preventDefault(); submitToApi(); });
      });
    })();
  </script>

  <script>
  /* Stripe Payment Element */
  (function(){
    const panel   = document.getElementById('stripePanel');
    const msgBox  = document.getElementById('stripeMsg');
    const payBtn  = document.getElementById('stripePayBtn');
    const confBtn = document.getElementById('stripeConfirmBtn');

    let stripe, elements, paymentElement, lastClientSecret = '';
    let currentMethodType = 'card';
    const redirectMethods = new Set(['klarna','revolut_pay','amazon_pay']);

    function amountFromTotalLine(){
      const txt = (document.getElementById('totalLine')?.textContent || '');
      const m   = txt.match(/£([\d.]+)/);
      const v   = m ? parseFloat(m[1]) : 0;
      return (isNaN(v) ? 0 : v).toFixed(2);
    }
    function markPaid(){
      const pill = document.getElementById('payStatus');
      if (pill){ pill.textContent='Payment: Paid'; pill.classList.add('paid'); }
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn){ submitBtn.disabled = false; submitBtn.classList.add('enabled'); }
      // NEW: immediately upsert details into the paid row so the worker sees DL/ref in "searching"
      if (window._upsertSearchRecord) { window._upsertSearchRecord(true); }
    }
    function showMsg(text, ok=false){
      panel.style.display = 'block';
      if (!msgBox) return;
      msgBox.textContent = text || '';
      msgBox.style.display = text ? 'block' : 'none';
      msgBox.classList.remove('success','fail');
      if (text) msgBox.classList.add(ok ? 'success' : 'fail');
    }
    function requireBookingTypeOrReject(){
      const isBook = document.getElementById('btnBook')?.classList.contains('selected');
      const isSwap = document.getElementById('btnSwap')?.classList.contains('selected');
      if (!isBook && !isSwap){ showMsg('Please select Book (£150) or Swap (£70) first.'); return false; }
      return true;
    }

    // Backend will create a draft search if search_id is missing
    async function createIntentIfNeeded(){
      const amount = amountFromTotalLine();
      if (!amount || isNaN(+amount) || +amount <= 0){ showMsg('Total is not valid.'); return false; }

      const existingSid = localStorage.getItem('dvsa_last_search_id');
      const email = (document.getElementById('email')?.value || '').trim() || null;

      try{
        const r = await fetch(`${API_BASE}/pay/create-intent`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            amount_cents: Math.round(parseFloat(amount)*100),
            currency: 'gbp',
            search_id: existingSid ? Number(existingSid) : null,
            email
          })
        });
        const text = await r.text(); let j; try { j = JSON.parse(text) } catch { j = null; }
        if(!r.ok || !j?.client_secret){ throw new Error(j?.detail || j?.error || text || 'Failed to create payment intent'); }
        if (j.search_id) localStorage.setItem('dvsa_last_search_id', String(j.search_id));
        lastClientSecret = j.client_secret;
        return true;
      }catch(err){
        console.error(err);
        showMsg('Stripe error: ' + (err?.message || err));
        return false;
      }
    }

    async function openStripePanel(){
      panel.style.display = 'block';
      if (!STRIPE_PUBLISHABLE_KEY){ showMsg('Stripe publishable key is missing on this page.'); return; }
      if (!requireBookingTypeOrReject()) return;
      const ok = await createIntentIfNeeded(); if (!ok) return;
      try{
        stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
        elements = stripe.elements({ clientSecret: lastClientSecret });
        if (paymentElement) paymentElement.unmount();
        paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');
        paymentElement.on('change', async (ev) => {
          currentMethodType = (ev?.value && ev.value.type) ? ev.value.type : 'card';
          if (redirectMethods.has(currentMethodType)) { showMsg('You will be redirected to complete payment…'); if (ev.complete) { await confirmRedirectMethod(); } }
          else { showMsg('', true); }
        });
        showMsg('', true); document.getElementById('stripePanel').scrollIntoView({behavior:'smooth', block:'center'});
      }catch(err){ console.error(err); showMsg('Stripe initialisation failed.'); }
    }

    async function confirmRedirectMethod(){
      const returnUrl = window.location.origin + window.location.pathname;
      const {error} = await stripe.confirmPayment({ elements, confirmParams: { return_url: returnUrl }, redirect: 'always' });
      if (error){ showMsg(error.message || 'Payment failed.'); }
    }

    async function confirmStripePayment(){
      if (redirectMethods.has(currentMethodType)) { showMsg('For Klarna, Revolut Pay or Amazon Pay, select the option above and you will be redirected automatically.'); return; }
      if (!stripe || !elements){ showMsg('Payment form is not ready yet.'); return; }
      confBtn.disabled = true;
      const returnUrl = window.location.origin + window.location.pathname;
      const {error, paymentIntent} = await stripe.confirmPayment({ elements, confirmParams: { return_url: returnUrl }, redirect: 'if_required' });
      if (error){ showMsg(error.message || 'Payment failed.'); confBtn.disabled = false; return; }
      if (paymentIntent && paymentIntent.status === 'succeeded'){ showMsg('Payment successful.', true); markPaid(); }
      else { showMsg('Payment was not completed.'); confBtn.disabled = false; }
    }

    payBtn?.addEventListener('click', (e)=>{ e.preventDefault(); openStripePanel(); });
    confBtn?.addEventListener('click', (e)=>{ e.preventDefault(); confirmStripePayment(); });

    // Handle return from a redirect payment
    (function handleStripeReturn(){
      const params = new URLSearchParams(window.location.search);
      const clientSecret = params.get('payment_intent_client_secret');
      if (clientSecret && STRIPE_PUBLISHABLE_KEY){
        try{
          stripe = stripe || Stripe(STRIPE_PUBLISHABLE_KEY);
          stripe.retrievePaymentIntent(clientSecret).then(({paymentIntent})=>{
            if (!paymentIntent) return;
            if (paymentIntent.status === 'succeeded'){ showMsg('Payment successful.', true); markPaid(); }
            else if (paymentIntent.status === 'processing'){ showMsg('Payment processing… please wait a moment.'); }
            else if (paymentIntent.last_payment_error){ showMsg(paymentIntent.last_payment_error.message || 'Payment failed.'); }
          });
        }catch(e){}
      }
    })();
  })();
  </script>

  <!-- ===================== Force booking buttons UNSELECTED on load ===================== -->
  <script>
    (function(){
      function clearBookingToggles(){
        ['btnBook','btnSwap'].forEach(id=>{
          const el=document.getElementById(id);
          if(el){ el.classList.remove('selected'); el.setAttribute('aria-pressed','false'); }
        });
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', clearBookingToggles);
      else clearBookingToggles();
    })();
  </script>
</body>
</html>





