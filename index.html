<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FastDrivingTestFinder — Book/Swap</title>

  <!-- Config (no stray tokens) -->
  <script>
    window.API_BASE = "https://api.fastdrivingtestfinder.co.uk/api";
    window.STRIPE_PUBLISHABLE_KEY = "pk_live_51S4HI5KDKDIajo9AAvqU8YiqHVgZQhQne3pJzejDKrL0s1OCWnOsRk7gcJWdHPl4k5yPIGoGiQ2QFRPzHPm884fO00YoZJ0mDn";
  </script>

  <style>
    body{font-family:Segoe UI,system-ui,Arial,sans-serif;background:#f7fafc;color:#0f172a;margin:0}
    .wrap{max-width:760px;margin:24px auto;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,.06);padding:18px}
    h1{margin:0 0 10px 0}
    .row{display:grid;grid-template-columns:180px 1fr;gap:12px;align-items:center;margin:8px 0}
    label{font-weight:600}
    input,select{height:34px;border:1px solid #e5e7eb;border-radius:6px;padding:6px 8px}
    .btn{background:#2563eb;color:#fff;border:none;border-radius:6px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#64748b}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .panel{border:1px dashed #cbd5e1;border-radius:10px;padding:12px;margin-top:14px}
    .pill{display:inline-block;background:#eef2ff;color:#1e40af;border-radius:999px;padding:6px 10px;font-weight:700}
    .error{color:#dc2626;margin-top:8px}
    .success{color:#16a34a;margin-top:8px}
    .note{color:#475569;font-size:13px}
    #payment-element{margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Book or Swap a DVSA Test</h1>

    <div class="panel">
      <div class="grid2">
        <button id="btnBook" class="btn secondary" type="button">Book a New Test</button>
        <button id="btnSwap" class="btn secondary" type="button">Swap an Existing Test</button>
      </div>
      <div class="row">
        <label for="theoryPass">Theory Pass No (for Book):</label>
        <input id="theoryPass" placeholder="e.g. 1234567890" maxlength="16"/>
      </div>
      <div class="row">
        <label for="swapRef">Booking Ref (for Swap):</label>
        <input id="swapRef" placeholder="8-digit booking ref" maxlength="8" inputmode="numeric"/>
      </div>
    </div>

    <div class="panel">
      <div class="row"><label for="surname">Surname:</label><input id="surname" placeholder="As on licence"/></div>
      <div class="row"><label for="email">Email:</label><input id="email" type="email" placeholder="you@email.com"/></div>
      <div class="row"><label for="licence">Licence No (first 16):</label><input id="licence" maxlength="16" placeholder="16 chars only"/></div>
      <div class="row"><label for="phone">UK WhatsApp:</label><input id="phone" placeholder="+44 7xxxxxxxxx"/></div>
    </div>

    <div class="panel">
      <div class="row"><label>Test Centre 1:</label><input class="centre" placeholder="Type a centre"/></div>
      <div class="row"><label>Test Centre 2:</label><input class="centre" placeholder="Optional"/></div>
      <div class="row"><label>Test Centre 3:</label><input class="centre" placeholder="Optional"/></div>
    </div>

    <div class="panel">
      <div class="row"><label>High-priority? (+£30)</label>
        <select id="prio"><option value="0">No</option><option value="30">Yes</option></select>
      </div>
      <div class="row"><label>Weekend slots? (+£30)</label>
        <select id="weekend"><option value="0">No</option><option value="30">Yes</option></select>
      </div>
      <div style="text-align:right;margin-top:8px"><span id="total" class="pill">Total: £70.00</span></div>
    </div>

    <div class="panel">
      <div class="grid2">
        <button id="stripePayBtn" class="btn" type="button">Payment options</button>
        <button id="stripeConfirmBtn" class="btn secondary" type="button">Pay now</button>
      </div>
      <div id="stripePanel" style="display:none">
        <div id="stripeMsg" class="note" style="margin-top:8px"></div>
        <div id="payment-element"></div>
      </div>
      <div id="payStatusWrap" style="margin-top:12px"><span id="payStatus" class="pill">Payment: Not Paid</span></div>
      <div id="payError" class="error" style="display:none"></div>
    </div>

    <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
      <button id="submitBtn" class="btn secondary" type="button" disabled>SUBMIT</button>
      <div id="liveMsg" class="note"></div>
    </div>
  </div>

  <!-- Stripe -->
  <script src="https://js.stripe.com/v3/"></script>

  <script>
    const API_BASE = window.API_BASE;
    const STRIPE_KEY = window.STRIPE_PUBLISHABLE_KEY;

    const $  = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));

    const btnBook = $('#btnBook');
    const btnSwap = $('#btnSwap');
    const theory  = $('#theoryPass');
    const swapRef = $('#swapRef');

    let bookingType = null; // 'new' or 'swap'

    function setType(t){
      bookingType = t;
      [btnBook,btnSwap].forEach(b=>b.classList.add('secondary'));
      (t==='new'?btnBook:btnSwap).classList.remove('secondary');
    }
    btnBook.onclick = ()=>setType('new');
    btnSwap.onclick = ()=>setType('swap');

    function centres(){
      return $$('.centre').map(i=>i.value.trim()).filter(Boolean);
    }

    function pounds(){
      const base = (bookingType==='new') ? 150 : 70;
      const add  = (+($('#prio').value||0)) + (+($('#weekend').value||0));
      return base + add;
    }
    function refreshTotal(){
      $('#total').textContent = `Total: £${pounds().toFixed(2)}`;
    }
    $('#prio').onchange = refreshTotal;
    $('#weekend').onchange = refreshTotal;
    refreshTotal();

    function toast(msg, ok=true){
      const el = $('#liveMsg');
      el.textContent = msg || '';
      el.style.color = ok ? '#065f46' : '#991b1b';
    }

    function normPhone(v){
      let d = (v||'').replace(/\D/g,'');
      if (d.startsWith('44')) d = d.slice(2);
      if (d.startsWith('0'))  d = d.slice(1);
      d = d.slice(0,10);
      return d ? ('0' + d) : '';
    }

    function validateMinimal(){
      if (!bookingType){ toast('Choose Book or Swap.'); return false; }
      if (!$('#surname').value.trim()){ toast('Enter surname.'); return false; }
      if (!$('#email').value.trim()){ toast('Enter email.'); return false; }
      if (!$('#licence').value.trim() || $('#licence').value.trim().length<10){ toast('Enter licence (first 16 chars).'); return false; }
      if (centres().length===0){ toast('Add at least one test centre.'); return false; }
      if (bookingType==='swap' && !/^\d{8}$/.test(swapRef.value.trim())){ toast('Add the 8-digit DVSA booking reference.'); return false; }
      return true;
    }

    async function ensureSearchId(){
      let id = localStorage.getItem('dvsa_last_search_id');
      if (id) return id;

      if (!validateMinimal()) throw new Error('missing fields');

      const payload = {
        booking_type: bookingType,
        licence_number: $('#licence').value.trim() || null,
        booking_reference: bookingType==='swap' ? swapRef.value.trim() : null,
        theory_pass: bookingType==='new' ? theory.value.trim() : null,
        phone: normPhone($('#phone').value),
        email: $('#email').value.trim(),
        centres: centres(),
        options: {
          high_priority: +($('#prio').value||0)>0,
          weekend: +($('#weekend').value||0)>0
        }
      };

      const r = await fetch(`${API_BASE}/search`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const t = await r.text(); let j=null; try{ j=JSON.parse(t) }catch{}
      if (!r.ok || !j?.search_id) throw new Error(j?.detail || t || `HTTP ${r.status}`);
      id = String(j.search_id);
      localStorage.setItem('dvsa_last_search_id', id);
      return id;
    }

    // ==== Stripe ====
    let stripe, elements, paymentElement, lastClientSecret = '';
    const redirectMethods = new Set(['klarna','revolut_pay','amazon_pay']);

    function markPaid(){
      $('#payStatus').textContent = 'Payment: Paid';
      const s = $('#submitBtn');
      s.disabled = false;
      s.classList.remove('secondary');
    }

    $('#stripePayBtn').onclick = async (e)=>{
      e.preventDefault();
      $('#payError').style.display='none';
      toast('');

      if (!validateMinimal()) return;

      // 1) Ensure we have a search id
      let sid;
      try{ sid = await ensureSearchId(); }
      catch(err){ $('#payError').textContent = err.message || String(err); $('#payError').style.display='block'; return; }

      // 2) Create a payment intent for the current total
      const amount = Math.round(pounds()*100);
      try{
        const r = await fetch(`${API_BASE}/pay/create-intent`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            search_id: Number(sid),
            amount, currency:'gbp',
            description: `Search #${sid}`,
            metadata: { search_id: String(sid) }
          })
        });
        const j = await r.json();
        if(!r.ok || !j?.clientSecret) throw new Error(j?.detail || 'Stripe create-intent failed');
        lastClientSecret = j.clientSecret;
      }catch(err){
        $('#payError').textContent = (err && err.message) ? err.message : String(err);
        $('#payError').style.display='block';
        return;
      }

      // 3) Render the Payment Element
      try{
        $('#stripePanel').style.display='block';
        stripe = Stripe(STRIPE_KEY);
        elements = stripe.elements({ clientSecret: lastClientSecret });
        if (paymentElement) try{ paymentElement.unmount(); }catch(_){}
        paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');
        $('#stripeMsg').textContent = '';
      }catch(err){
        $('#payError').textContent = 'Stripe initialisation failed.';
        $('#payError').style.display='block';
      }
    };

    $('#stripeConfirmBtn').onclick = async (e)=>{
      e.preventDefault();
      if (!stripe || !elements){ $('#payError').textContent='Payment form is not ready.'; $('#payError').style.display='block'; return; }

      const {error, paymentIntent} = await stripe.confirmPayment({
        elements,
        confirmParams:{ return_url: window.location.origin + window.location.pathname },
        redirect:'if_required'
      });
      if (error){
        $('#payError').textContent = error.message || 'Payment failed.';
        $('#payError').style.display='block';
        return;
      }
      if (paymentIntent && paymentIntent.status==='succeeded'){
        $('#payError').style.display='none';
        toast('Payment successful.', true);
        markPaid();
      } else {
        $('#payError').textContent='Payment was not completed.';
        $('#payError').style.display='block';
      }
    };

    // Submit (after paid) — keeps same row; API already has all details from /search earlier
    $('#submitBtn').onclick = ()=>{
      toast('Thanks! Your search is active. We’ll notify you when we find a slot.', true);
      // You can hard-reset the form if you want here.
    };
  </script>
</body>
</html>
