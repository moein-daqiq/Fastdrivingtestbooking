<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="canonical" href="https://fastdrivingtestfinder.co.uk/">
  <title>Driving Test Cancellation Finder | Earlier DVSA Dates — FastDrivingTestFinder</title>
  <meta name="description" content="Find earlier DVSA driving test dates and cancellations UK-wide. We scan centres 24/7 and send instant alerts so you can book or swap a sooner test.">

  <!-- API + Stripe publishable key -->
  <script>var API_BASE = "https://api.fastdrivingtestfinder.co.uk/api";</script>
  <script>window.STRIPE_PUBLISHABLE_KEY = "pk_live_51S4HI5KDKDIajo9AAvqU8YiqHVgZQhQne3pJzejDKrL0s1OCWnOsRk7gcJWdHPl4k5yPIGoGiQ2QFRPzHPm884fO00YoZJ0mDn";</script>

  <style>
    body{ margin:0;font-family:"Segoe UI","Helvetica Neue",Arial,Helvetica,sans-serif;background:#f7fafc;color:#0f172a;line-height:1.45 }
    .wrap{max-width:760px;margin:10px auto;background:#fff;border:1px solid #e5e7eb;box-shadow:0 2px 16px rgba(15,23,42,.06)}
    .strip{padding:10px 12px;text-align:center;color:#fff;font-weight:700}
    .strip.title{background:linear-gradient(180deg,#60a5fa 0%, #3b82f6 100%)}
    .strip.subtitle{background:#34d399}
    section.panel{border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 2px 10px rgba(15,23,42,.04);padding:16px 18px;margin:16px}
    .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-top:10px}
    label{font-size:14px;font-weight:bold}
    input,select{box-sizing:border-box;height:34px;padding:6px 8px;border:1px solid #e5e7eb;border-radius:4px;background:#fff}
    .btn{background:#2563eb;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;height:34px}
    .btn.selected{background:#1e40af}
    .centre-input{width:100%}
    .submit-btn{flex:1;background:#2563eb;color:#fff;padding:10px;border:none;font-size:15px;border-radius:4px;cursor:pointer;opacity:.6}
    .submit-btn.enabled{opacity:1}
    .status-pill{padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;background:#eef2ff;color:#1e40af}
    .status-pill.paid{background:#ecfdf5;color:#16a34a}
    .indicator{margin-top:12px;text-align:center;font-weight:bold;display:none}
    .indicator.success{color:#16a34a}.indicator.fail{color:#dc2626}
    #stripePanel{display:none;margin-top:12px;padding:12px;border:1px dashed #e5e7eb;border-radius:10px;background:#fff}
    @media (max-width:560px){ .wrap{max-width:100%;margin:0;border:none;box-shadow:none} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="strip title">Risk-Free, Stress-Free Booking</div>
  <div class="strip subtitle">Money-Back Guarantee</div>

  <!-- ========== Test Booking Type ========== -->
  <section class="panel" id="type">
    <div class="row">
      <button class="btn" id="btnBook" aria-pressed="false">Book a New Test</button>
      <input type="text" id="theoryPass" placeholder="Theory test pass number" maxlength="16" autocomplete="off"/>

      <button class="btn" id="btnSwap" aria-pressed="false">Swap an Existing Test</button>
      <input type="text" id="swapRef" placeholder="8-digit booking reference" maxlength="8" inputmode="numeric" autocomplete="off"/>
    </div>
  </section>

  <!-- ========== Applicant Details ========== -->
  <section class="panel" id="applicant">
    <div class="row" style="display:grid;grid-template-columns:220px 1fr;gap:12px;align-items:center">
      <label for="surname">Surname(s):</label>
      <input type="text" id="surname" placeholder="Exactly as on licence"/>

      <label for="firstname">First/Middle Name(s):</label>
      <input type="text" id="firstname" placeholder="Exactly as on licence"/>

      <label for="drivingLicence">Driving Licence No:</label>
      <input type="text" id="drivingLicence" placeholder="FIRST 16 CHARACTERS ONLY" maxlength="16"/>

      <label for="email">Email:</label>
      <input type="email" id="email" placeholder="name@email.com" autocomplete="email"/>

      <label for="phoneRaw">UK WhatsApp Phone No:</label>
      <input type="tel" id="phoneRaw" placeholder="+44 7xxxxxxxxx"/>
    </div>
  </section>

  <!-- ========== Test Centres ========== -->
  <section class="panel">
    <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div>
        <label>Test Centre 1:</label>
        <input class="centre-input" list="testCentresList" placeholder="Choose your centre" />
      </div>
      <div>
        <label>Test Centre 2:</label>
        <input class="centre-input" list="testCentresList" placeholder="Choose your centre" />
      </div>
      <div>
        <label>Test Centre 3:</label>
        <input class="centre-input" list="testCentresList" placeholder="Choose your centre" />
      </div>
      <div>
        <label>Test Centre 4:</label>
        <input class="centre-input" list="testCentresList" placeholder="Choose your centre" />
      </div>
      <div>
        <label>Test Centre 5:</label>
        <input class="centre-input" list="testCentresList" placeholder="Choose your centre" />
      </div>
      <div>
        <label>Test Centre 6:</label>
        <input class="centre-input" list="testCentresList" placeholder="Choose your centre" />
      </div>
    </div>
    <datalist id="testCentresList"></datalist>
  </section>

  <!-- ========== Date/Time & Payment ========== -->
  <section class="panel">
    <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div>
        <label>Earliest Date:</label>
        <input id="earliestDate" type="date"/>
      </div>
      <div>
        <label>Latest Date:</label>
        <input id="latestDate" type="date"/>
      </div>
      <div>
        <label>From (hour):</label>
        <input type="number" id="timeFrom" min="1" max="12" value="7"/>
      </div>
      <div>
        <label>To (hour):</label>
        <input type="number" id="timeTo" min="1" max="12" value="7"/>
      </div>
      <div>
        <label>Notice days:</label>
        <input type="number" id="noticeDays" min="0" max="15" value="0"/>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div style="flex:1">
        <div class="row" style="justify-content:space-between">
          <div>1. High-priority searching? +£30</div>
          <div class="yesno" id="yn1"><button class="btn" data-price="30">Yes</button><button class="btn" data-price="0">No</button></div>
        </div>
        <div class="row" style="justify-content:space-between">
          <div>2. Include weekend test slots? +£30</div>
          <div class="yesno" id="yn2"><button class="btn" data-price="30">Yes</button><button class="btn" data-price="0">No</button></div>
        </div>
        <div id="totalLine" style="font-weight:bold;text-align:right;margin-top:8px">Total: £0.00</div>

        <div class="row" style="border-top:1px dashed #e5e7eb;padding-top:10px">
          <button id="stripePayBtn" class="submit-btn enabled" style="width:100%;max-width:360px;background:#635bff">
            Payment options
          </button>
        </div>

        <div id="stripePanel">
          <div id="stripeMsg" class="indicator"></div>
          <div id="payment-element" style="margin-top:8px"></div>
          <button id="stripeConfirmBtn" class="submit-btn enabled" style="margin-top:12px;width:100%;max-width:360px">
            Pay now
          </button>
        </div>

        <div class="submit-row" style="display:flex;align-items:center;gap:12px;margin-top:16px">
          <div id="payStatus" class="status-pill">Payment: Not Paid</div>
          <button class="submit-btn" id="submitBtn" disabled>SUBMIT</button>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- ===== Utilities & form logic (centres, totals, create search) ===== -->
<script>
  const $  = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const pad = (n) => String(n).padStart(2,'0');
  const toHH    = (n) => `${pad((+n||0) === 12 ? 0 : (+n||0))}:00`;
  const toHHpm  = (n) => `${pad((+n||0) === 12 ? 12 : (+n||0)+12)}:00`;

  function centresArray(){
    return $$('.centre-input').map(i => (i.value || '').trim()).filter(Boolean);
  }
  function money(n){ return `£${n.toFixed(2)}`; }
  function ymd(el){
    const v = (el && el.value ? el.value.trim() : '');
    if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
    return '';
  }
  function normalizePhone(v){
    let d = (v||'').replace(/\D/g,'');
    if (d.startsWith('44')) d = d.slice(2);
    if (d.startsWith('0'))  d = d.slice(1);
    d = d.slice(0,10);
    return d ? ('0' + d) : '';
  }

  // Busy centre surcharge list (same as before)
  const BUSY = new Set([
    'barking','chertsey','chingford','farnborough','goodmayes','greenford',
    'high wycombe','hornchurch','hounslow','leighton buzzard','letchworth','luton','morden',
    'oxford','pinner','reading','slough','southall','tolworth','uxbridge','wanstead',
    'west didsbury'
  ]);
  const normCentre = v => (v||'').toLowerCase().replace(/\s*\([^)]*\)/g,'').replace(/^london\s+/,'').replace(/\s+/g,' ').trim();

  function baseYesNoSum(){
    let sum=0;
    $$('.yesno .btn.selected').forEach(b => sum += Number(b.dataset.price || 0) || 0);
    return sum;
  }
  function bookingFee(){
    const b = $('#btnBook')?.classList.contains('selected');
    const s = $('#btnSwap')?.classList.contains('selected');
    if (b) return 150;
    if (s) return 70;
    return 0;
  }
  function busySurcharge(){
    let count=0;
    $$('.centre-input').forEach(inp => { if (inp.value && BUSY.has(normCentre(inp.value))) count++; });
    return count*30;
  }
  function recalc(){
    const gross = baseYesNoSum() + bookingFee() + busySurcharge();
    const isBook = $('#btnBook')?.classList.contains('selected');
    const isSwap = $('#btnSwap')?.classList.contains('selected');
    let total = gross;
    if (isBook) total = Math.max(150, total);
    if (isSwap) total = Math.max(70, total);
    $('#totalLine').textContent = 'Total: ' + money(total);
  }
  window.addEventListener('click', (e)=>{
    const btn = e.target.closest('.yesno .btn');
    if (!btn) return;
    const group = btn.parentElement;
    group.querySelectorAll('.btn').forEach(b => { b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
    btn.classList.add('selected'); btn.setAttribute('aria-pressed','true');
    recalc();
  });

  // booking toggles
  (function(){
    const btnBook=$('#btnBook'), btnSwap=$('#btnSwap'), theory=$('#theoryPass'), swapRef=$('#swapRef');
    function select(btn){
      [btnBook, btnSwap].forEach(b => { b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
      btn.classList.add('selected'); btn.setAttribute('aria-pressed','true');
      recalc();
    }
    btnBook?.addEventListener('click', ()=>select(btnBook));
    btnSwap?.addEventListener('click', ()=>select(btnSwap));
    swapRef?.addEventListener('input', ()=>{ swapRef.value = swapRef.value.replace(/\D/g,'').slice(0,8); });
    theory?.addEventListener('input', ()=>{ theory.value = theory.value.replace(/[^a-z0-9]/gi,'').slice(0,16); });
  })();

  // centres list (all centres; minimal safe list here; you can expand as needed)
  (function(){
    const ALL = [
      "Aberdeen","Aberdare","Abergavenny","Atherton","Barnet","Barking (Tanner Street)","Basingstoke",
      "Belfast","Birmingham","Borehamwood","Bradford","Brentwood","Bridgend","Brighton","Bristol",
      "Cambridge","Cardiff","Chertsey","Chingford","Coventry","Croydon","Derby","Doncaster",
      "Edinburgh","Elgin","Exeter","Farnborough","Glasgow","Goodmayes","Greenford","Guildford",
      "Hendon","Hornchurch","Hounslow","Ipswich","Leeds","Leicester","Leighton Buzzard","Letchworth",
      "Liverpool","Luton","Manchester","Morden","Newcastle upon Tyne","Norwich","Nottingham","Oxford",
      "Pinner","Portsmouth","Reading","Slough","Southall","Southampton","Tolworth","Uxbridge","Watford",
      "West Didsbury (Manchester)","Wimbledon","Wolverhampton","York","Borehamwood","Barnet (London)"
    ].sort((a,b)=>a.localeCompare(b));
    const dl = $('#testCentresList');
    dl.innerHTML = '';
    const frag = document.createDocumentFragment();
    ALL.forEach(c => { const o=document.createElement('option'); o.value=c; frag.appendChild(o); });
    dl.appendChild(frag);
  })();

  // ensurePreSearch: create (or reuse) a search id BEFORE Stripe
  async function ensurePreSearch(){
    let sid = localStorage.getItem('dvsa_last_search_id');
    if (sid) return sid;

    const centres = centresArray();
    const email = ($('#email')?.value || '').trim();
    const isBook = $('#btnBook')?.classList.contains('selected');
    const isSwap = $('#btnSwap')?.classList.contains('selected');

    if (!centres.length) throw new Error('Choose at least one Test Centre.');
    if (!email) throw new Error('Enter your Email.');
    if (!isBook && !isSwap) throw new Error('Select Book or Swap first.');

    const body = {
      booking_type: isBook ? 'new' : 'swap',
      email,
      centres
    };
    if (isSwap) {
      const ref = ($('#swapRef')?.value || '').trim();
      if (/^\d{8}$/.test(ref)) body.booking_reference = ref;
    }

    const r = await fetch(`${API_BASE}/search`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const txt = await r.text();
    let j; try { j = JSON.parse(txt) } catch { j = null; }
    if (!r.ok) throw new Error(j?.detail || j?.error || txt || `HTTP ${r.status}`);

    sid = j?.search_id || j?.id;
    if (sid) localStorage.setItem('dvsa_last_search_id', String(sid));
    return sid;
  }

  // SUBMIT final (after payment)
  async function submitToApi(){
    const btn = $('#submitBtn');
    if (!btn || btn.disabled) return;

    const p = {
      email:  ($('#email')?.value || '').trim(),
      phone:  normalizePhone($('#phoneRaw')?.value),
      centres: centresArray(),

      date_window_from: ymd($('#earliestDate')),
      date_window_to:   ymd($('#latestDate')),
      time_window_from: toHH($('#timeFrom')?.value),
      time_window_to:   toHHpm($('#timeTo')?.value),

      licence_number:   ($('#drivingLicence')?.value || '').trim(),
      booking_type:     $('#btnBook')?.classList.contains('selected') ? 'new' : 'swap',
      booking_reference: $('#btnSwap')?.classList.contains('selected') ? ($('#swapRef')?.value || '').trim() : undefined,
      theory_pass:       $('#btnBook')?.classList.contains('selected') ? ($('#theoryPass')?.value || '').trim() : undefined
    };

    // re-create the row with full payload is optional; most builds store details later via worker.
    // Here we just thank the user.
    alert('Your request has been submitted. We will start searching shortly.');
    btn.disabled = true; btn.classList.remove('enabled');
  }
</script>

<!-- ===== Stripe.js + Payment flow (creates intent AFTER ensurePreSearch) ===== -->
<script src="https://js.stripe.com/v3/"></script>
<script>
(function(){
  const STRIPE_PUBLISHABLE_KEY = window.STRIPE_PUBLISHABLE_KEY || '';
  const panel   = document.getElementById('stripePanel');
  const msgBox  = document.getElementById('stripeMsg');
  const payBtn  = document.getElementById('stripePayBtn');
  const confBtn = document.getElementById('stripeConfirmBtn');

  let stripe, elements, paymentElement, lastClientSecret = '';
  const redirectMethods = new Set(['klarna','revolut_pay','amazon_pay']);

  function showMsg(text, ok=false){
    panel.style.display = 'block';
    msgBox.textContent = text || '';
    msgBox.style.display = text ? 'block' : 'none';
    msgBox.classList.remove('success','fail');
    msgBox.classList.add(ok ? 'success' : 'fail');
  }

  function amountFromTotalLine(){
    const m = (document.getElementById('totalLine')?.textContent || '').match(/£([\d.]+)/);
    return m ? parseFloat(m[1]) : 0;
  }
  function markPaid(){
    const pill = document.getElementById('payStatus');
    if (pill){ pill.textContent='Payment: Paid'; pill.classList.add('paid'); }
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn){ submitBtn.disabled = false; submitBtn.classList.add('enabled'); }
  }

  async function createIntentIfNeeded(){
    const pounds = amountFromTotalLine();
    if (!Number.isFinite(pounds) || pounds <= 0){ showMsg('Total is not valid.'); return false; }

    let sid;
    try { sid = await ensurePreSearch(); }
    catch (e) { showMsg(e.message || String(e)); return false; }

    try{
      const r = await fetch(`${API_BASE}/pay/create-intent`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          search_id: Number(sid),
          amount: Math.round(pounds*100),
          currency: 'gbp',
          description: `Search #${sid}`,
          metadata: { search_id: String(sid) }
        })
      });
      const j = await r.json();
      if(!r.ok || !j?.clientSecret){
        throw new Error(j?.detail || j?.error || 'Failed to create payment intent');
      }
      lastClientSecret = j.clientSecret;
      return true;
    }catch(err){
      showMsg('Stripe error: ' + (err?.message || err));
      return false;
    }
  }

  async function openStripePanel(){
    panel.style.display = 'block';
    const isBook = document.getElementById('btnBook')?.classList.contains('selected');
    const isSwap = document.getElementById('btnSwap')?.classList.contains('selected');
    if (!isBook && !isSwap){ showMsg('Please select Book (£150) or Swap (£70) first.'); return; }

    const ok = await createIntentIfNeeded();
    if (!ok) return;

    try{
      stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
      elements = stripe.elements({ clientSecret: lastClientSecret });
      if (paymentElement) paymentElement.unmount();
      paymentElement = elements.create('payment');
      paymentElement.mount('#payment-element');
      showMsg('', true);
      window.__stripeUnmount = () => { try{ paymentElement.unmount(); }catch(_){} };
    }catch(err){
      showMsg('Stripe initialisation failed.');
    }
  }

  async function confirmStripePayment(){
    if (!stripe || !elements){ showMsg('Payment form is not ready yet.'); return; }
    const {error, paymentIntent} = await stripe.confirmPayment({
      elements,
      confirmParams: { return_url: window.location.origin + window.location.pathname },
      redirect: 'if_required'
    });
    if (error){ showMsg(error.message || 'Payment failed.'); return; }
    if (paymentIntent && paymentIntent.status === 'succeeded'){ showMsg('Payment successful.', true); markPaid(); }
    else { showMsg('Payment was not completed.'); }
  }

  payBtn?.addEventListener('click', (e)=>{ e.preventDefault(); openStripePanel(); });
  confBtn?.addEventListener('click', (e)=>{ e.preventDefault(); confirmStripePayment(); });

  document.getElementById('submitBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); submitToApi(); });

  // handle redirected return
  (function(){
    const params = new URLSearchParams(window.location.search);
    const clientSecret = params.get('payment_intent_client_secret');
    if (clientSecret && STRIPE_PUBLISHABLE_KEY){
      try{
        const s = Stripe(STRIPE_PUBLISHABLE_KEY);
        s.retrievePaymentIntent(clientSecret).then(({paymentIntent})=>{
          if (!paymentIntent) return;
          if (paymentIntent.status === 'succeeded'){ showMsg('Payment successful.', true); markPaid(); }
          else if (paymentIntent.status === 'processing'){ showMsg('Payment processing…'); }
          else if (paymentIntent.last_payment_error){ showMsg(paymentIntent.last_payment_error.message || 'Payment failed.'); }
        });
      }catch(_){}
    }
  })();

  // initial total
  recalc();
})();
</script>
</body>
</html>
